"""
final_submission.py
ĞĞ±ÑƒÑ‡ĞµĞ½Ğ¸Ğµ LightGBM + ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ submission.csv
ĞšĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° id ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸
"""

import pandas as pd
import numpy as np
import json
import joblib
from sklearn.model_selection import train_test_split
from lightgbm import LGBMClassifier
from sklearn.metrics import f1_score, accuracy_score, roc_auc_score
import warnings
warnings.filterwarnings('ignore')

print("=" * 80)
print("ğŸ† Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞĞ• ĞĞ‘Ğ£Ğ§Ğ•ĞĞ˜Ğ• + Ğ¡ĞĞ‘ĞœĞ˜Ğ¨Ğ")
print("=" * 80)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ Ğ”ĞĞĞĞ«Ğ¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
print("\nğŸ“‚ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...")

train = pd.read_csv('train_fixed.csv')
test = pd.read_csv('test.csv')

print(f"âœ… Train: {len(train)} ÑÑ‚Ñ€Ğ¾Ğº")
print(f"âœ… Test: {len(test)} ÑÑ‚Ñ€Ğ¾Ğº")
print(f"âœ… ĞšĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸ train: {list(train.columns)}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. ĞŸĞĞ”Ğ“ĞĞ¢ĞĞ’ĞšĞ ĞŸĞ Ğ˜Ğ—ĞĞĞšĞĞ’ (id ĞĞ• Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼!)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
print("\nğŸ”§ ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°ĞºĞ¾Ğ²...")

# â— Ğ’ĞĞ–ĞĞ: Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ 'id' Ğ¸ Ñ†ĞµĞ»ĞµĞ²ÑƒÑ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ Ğ¸Ğ· Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°ĞºĞ¾Ğ²
feature_cols = [col for col in train.columns if col not in ['id', 'Heart Disease']]

X = train[feature_cols]
y = train['Heart Disease'].map({'Absence': 0, 'Presence': 1})

X_test = test[feature_cols]
test_ids = test['id']  # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ id Ğ´Ğ»Ñ ÑĞ°Ğ±Ğ¼Ğ¸ÑˆĞ½Ğ°

print(f"âœ… ĞŸÑ€Ğ¸Ğ·Ğ½Ğ°ĞºĞ¾Ğ²: {len(feature_cols)}")
print(f"âœ… ĞšĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸ Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°ĞºĞ¾Ğ²: {feature_cols}")
print(f"âœ… id Ğ¸ÑĞºĞ»ÑÑ‡Ñ‘Ğ½ Ğ¸Ğ· Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ñ")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. ĞĞ‘Ğ£Ğ§Ğ•ĞĞ˜Ğ• ĞœĞĞ”Ğ•Ğ›Ğ˜ (LightGBM â€” Ğ»ÑƒÑ‡ÑˆĞ°Ñ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
print("\nğŸ¯ ĞĞ±ÑƒÑ‡ĞµĞ½Ğ¸Ğµ LightGBM...")

model = LGBMClassifier(
    n_estimators=100,
    max_depth=6,
    learning_rate=0.1,
    class_weight='balanced',
    random_state=42,
    verbose=-1,
    n_jobs=-1
)

model.fit(X, y)
print("âœ… ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ°")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ ĞĞ Ğ’ĞĞ›Ğ˜Ğ”ĞĞ¦Ğ˜Ğ˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
print("\nğŸ“Š ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸...")

X_train, X_val, y_train, y_val = train_test_split(X, y, test_size=10000, random_state=42, stratify=y)
model_val = LGBMClassifier(
    n_estimators=100, max_depth=6, learning_rate=0.1,
    class_weight='balanced', random_state=42, verbose=-1, n_jobs=-1
)
model_val.fit(X_train, y_train)

y_val_proba = model_val.predict_proba(X_val)[:, 1]

# ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ€Ğ¾Ğ³ Ğ¸Ğ· ÑĞºÑĞ¿ĞµÑ€Ğ¸Ğ¼ĞµĞ½Ñ‚Ğ¾Ğ²
threshold = 0.46
y_val_pred = (y_val_proba >= threshold).astype(int)

val_f1 = f1_score(y_val, y_val_pred)
val_acc = accuracy_score(y_val, y_val_pred)
val_auc = roc_auc_score(y_val, y_val_proba)

print(f"âœ… Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ F1: {val_f1:.4f}")
print(f"âœ… Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Accuracy: {val_acc:.4f}")
print(f"âœ… Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ ROC-AUC: {val_auc:.4f}")
print(f"âœ… ĞŸĞ¾Ñ€Ğ¾Ğ³: {threshold}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. ĞŸĞ Ğ•Ğ”Ğ¡ĞšĞĞ—ĞĞĞ˜Ğ¯ ĞĞ Ğ¢Ğ•Ğ¡Ğ¢Ğ•
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
print("\nğŸ”® ĞŸÑ€ĞµĞ´ÑĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ñ‚ĞµÑÑ‚Ğµ...")

y_test_proba = model.predict_proba(X_test)[:, 1]
y_test_pred = (y_test_proba >= threshold).astype(int)

print(f"âœ… ĞšĞ»Ğ°ÑÑ 0: {(y_test_pred == 0).sum()} ({(y_test_pred == 0).mean()*100:.1f}%)")
print(f"âœ… ĞšĞ»Ğ°ÑÑ 1: {(y_test_pred == 1).sum()} ({(y_test_pred == 1).mean()*100:.1f}%)")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6. Ğ¡ĞĞ—Ğ”ĞĞĞ˜Ğ• SUBMISSION.CSV
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
print("\nğŸ“¤ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ submission.csv...")

submission = pd.DataFrame({
    'id': test_ids,
    'Heart Disease': y_test_pred
})

submission.to_csv('submission.csv', index=False)

print(f"âœ… Ğ¡Ñ‚Ñ€Ğ¾Ğº Ğ² ÑĞ°Ğ±Ğ¼Ğ¸ÑˆĞ½Ğµ: {len(submission)}")
print(f"âœ… ĞšĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸: {list(submission.columns)}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 7. Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ• ĞœĞĞ”Ğ•Ğ›Ğ˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
print("\nğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ğ²...")

joblib.dump(model, 'model_lightgbm_final.pkl')
joblib.dump(feature_cols, 'feature_cols.pkl')

with open('model_config.json', 'w', encoding='utf-8') as f:
    json.dump({
        'model': 'LightGBM',
        'threshold': threshold,
        'feature_cols': feature_cols,
        'val_f1': float(val_f1),
        'val_accuracy': float(val_acc),
        'val_roc_auc': float(val_auc)
    }, f, indent=2)

print("âœ… model_lightgbm_final.pkl")
print("âœ… feature_cols.pkl")
print("âœ… model_config.json")
print("âœ… submission.csv")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 8. Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞ«Ğ™ ĞĞ¢Ğ§ĞĞ¢
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
print("\n" + "=" * 80)
print("ğŸ“Š Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞ«Ğ™ ĞĞ¢Ğ§ĞĞ¢")
print("=" * 80)
print(f"\nğŸ† ĞœĞ¾Ğ´ĞµĞ»ÑŒ: LightGBM")
print(f"ğŸ“ˆ F1-Score: {val_f1:.4f}")
print(f"ğŸ“ˆ Accuracy: {val_acc:.4f}")
print(f"ğŸ“ˆ ROC-AUC: {val_auc:.4f}")
print(f"ğŸ¯ ĞŸĞ¾Ñ€Ğ¾Ğ³: {threshold}")
print(f"ğŸ“ Submission: submission.csv ({len(submission)} ÑÑ‚Ñ€Ğ¾Ğº)")
print(f"ğŸ“ ĞŸÑ€Ğ¸Ğ·Ğ½Ğ°ĞºĞ¾Ğ²: {len(feature_cols)} (id Ğ¸ÑĞºĞ»ÑÑ‡Ñ‘Ğ½)")
print("\nâœ… Ğ“ĞĞ¢ĞĞ’Ğ Ğš Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ• ĞĞ KAGGLE!")
print("=" * 80)